"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[2537],{69427(e,t,r){r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>d,frontMatter:()=>o,metadata:()=>a,toc:()=>p});const a=JSON.parse('{"id":"integrations/crawler","title":"Crawler","description":"Web crawler integration using Google Puppeteer to scrape data from JavaScript-rendered websites, with an example of extracting weather forecast data.","source":"@site/docs/integrations/crawler.md","sourceDirName":"integrations","slug":"/integrations/crawler","permalink":"/docs/integrations/crawler","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":220,"frontMatter":{"sidebar_position":220,"description":"Web crawler integration using Google Puppeteer to scrape data from JavaScript-rendered websites, with an example of extracting weather forecast data.","keywords":["web crawler","Puppeteer","web scraping","headless browser","data extraction","JavaScript","weather forecast"]},"sidebar":"defaultSidebar","previous":{"title":"Smart meter","permalink":"/docs/integrations/smartmeter"},"next":{"title":"People counter","permalink":"/docs/integrations/counter"}}');var n=r(74848),i=r(28453);const o={sidebar_position:220,description:"Web crawler integration using Google Puppeteer to scrape data from JavaScript-rendered websites, with an example of extracting weather forecast data.",keywords:["web crawler","Puppeteer","web scraping","headless browser","data extraction","JavaScript","weather forecast"]},s="Crawler",c={},p=[{value:"Web service",id:"web-service",level:2},{value:"Script",id:"script",level:2},{value:"Secret",id:"secret",level:2},{value:"Importer",id:"importer",level:2}];function l(e){const t={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.header,{children:(0,n.jsx)(t.h1,{id:"crawler",children:"Crawler"})}),"\n",(0,n.jsxs)(t.p,{children:["For static web sites you can use a HTTP request to get the page content in HTML and then use JavaScript to extract the information. Most websites use JavaScript to dynamically create HTML and on those sites this approach does not work. This integration uses the Google ",(0,n.jsx)(t.a,{href:"https://puppeteer.github.io/puppeteer/",children:"Puppeteer"})," library for Node to emulate a web driver with JavaScript support."]}),"\n",(0,n.jsxs)(t.blockquote,{children:["\n",(0,n.jsx)(t.p,{children:"Usage: Extract data from a web site"}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"web-service",children:"Web service"}),"\n",(0,n.jsx)(t.p,{children:"To install the web service on your local cluster run:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"helm install crawler spacetime/crawler\n"})}),"\n",(0,n.jsx)(t.h2,{id:"script",children:"Script"}),"\n",(0,n.jsx)(t.p,{children:"In this example we will scrape the contents of a weather forecast web site."}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{src:r(2415).A+"",width:"2026",height:"1246"})}),"\n",(0,n.jsxs)(t.p,{children:["The script below is a standard puppeteer script. You can develop and test the script in nodejs. Create a new ",(0,n.jsx)(t.code,{children:"Script"})," and add the following to the definition:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-javascript",children:"const get = async (url) => {\n    const browser = await puppeteer.launch({ args: ['--no-sandbox'] })\n    const page = await browser.newPage()\n    const navigationPromise = page.waitForNavigation()\n\n\n    await page.setViewport({ width: 1386, height: 878 })\n    await page.goto(url)\n\n    await navigationPromise\n\n\n    var forecast = {\n        precipitation: { next_hour: -1, tomorrow: -1, day_after_tomorrow: -1 },\n        temperature: {\n            min: { tomorrow: -30, day_after_tomorrow: -30 },\n            max: { tomorrow: -30, day_after_tomorrow: -30 }\n        }\n    }\n\n    var selector = '.forecast:nth-child(1) tr > td:nth-child(8)'\n    await page.waitForSelector(selector)\n    forecast.precipitation.next_hour = await page.$eval(selector, data => { return data.innerText })\n    var i = 1;\n    for (let field of Object.keys(forecast.precipitation)) {\n        selector = '.forecast:nth-child(' + i + ') tr > td:nth-child(8)'\n        var rainPerHour = await page.$$eval(selector, anchors => {\n            return anchors.map(anchor => {\n                return parseFloat(anchor.textContent.split(' ')[0].replace(',', '.'))\n            })\n        })\n        var total = 0;\n        print(rainPerHour)\n        if (i === 1) {\n            forecast.precipitation[field] = rainPerHour[0];\n        } else {\n            rainPerHour.forEach(p => { total += p })\n            forecast.precipitation[field] = Math.round(10 * total) / 10\n        }\n        ++i\n    }\n    i = 2\n    for (let field of Object.keys(forecast.temperature.min)) {\n        selector = '.forecast:nth-child(' + i + ') tr > td:nth-child(3)'\n        var tempPerHour = await page.$$eval(selector, anchors => {\n            return anchors.map(anchor => parseInt(anchor.textContent.split('\xb0')[0])\n            )\n        })\n        var max = -30\n        var min = 50\n        console.log(tempPerHour)\n        tempPerHour.forEach(p => { max = Math.max(max, p), min = Math.min(min, p) })\n        forecast.temperature.max[field] = Math.round(max)\n        forecast.temperature.min[field] = Math.round(min)\n        ++i\n    }\n    await browser.close()\n    return forecast\n}\n"})}),"\n",(0,n.jsxs)(t.p,{children:["To test the script enter the code below in the ",(0,n.jsx)(t.code,{children:"test"})," section and select ",(0,n.jsx)(t.code,{children:"Run"}),"."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-javascript",children:"var forecast = await get('https://www.buienradar.nl/weer/eersel/nl/2756342/5daagse')\nprint(\"Forecast:\" + JSON.stringify(forecast))\n"})}),"\n",(0,n.jsx)(t.h2,{id:"secret",children:"Secret"}),"\n",(0,n.jsx)(t.p,{children:"Create a new secret to set this script as the data source."}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{src:r(75572).A+"",width:"2732",height:"502"})}),"\n",(0,n.jsx)(t.h2,{id:"importer",children:"Importer"}),"\n",(0,n.jsxs)(t.p,{children:["Create a new importer and set the ",(0,n.jsx)(t.code,{children:"Datasource"})," to the name of the secret. In the object mapping you can link to topic to the URL that is passed to the script. The key mapping extracts the data from the returned JSON objects."]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{src:r(52374).A+"",width:"2732",height:"1802"})})]})}function d(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},2415(e,t,r){r.d(t,{A:()=>a});const a=r.p+"assets/images/buienradar-78e472636842b171de82fc543226a2f4.png"},52374(e,t,r){r.d(t,{A:()=>a});const a=r.p+"assets/images/importer_weather_radar-03061c9861b50bb9f6f75556553613e6.png"},75572(e,t,r){r.d(t,{A:()=>a});const a=r.p+"assets/images/secret_weather_radar-f04e35c2cecf14e23985e1ddd27c67cc.png"},28453(e,t,r){r.d(t,{R:()=>o,x:()=>s});var a=r(96540);const n={},i=a.createContext(n);function o(e){const t=a.useContext(i);return a.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:o(e.components),a.createElement(i.Provider,{value:t},e.children)}}}]);